{% extends "adminbase.html.twig" %} {# Ensure this matches your base template file name #}

{% block title %}Admin - Manage Categories{% endblock %}

{# Add custom styles for this page #}
{% block styles %}
    {{ parent() }} {# Include styles from base template #}
    <style>
        /* Dark theme for form controls */
        .form-control-dark {
            background-color: var(--topbar-search-bg);
            border: 1px solid var(--input-border-color);
            color: var(--topbar-search-text) !important;
        }
        .form-control-dark::placeholder {
            color: var(--muted-text-color);
        }
        .form-control-dark:focus {
            background-color: var(--topbar-search-bg);
            border-color: var(--sidebar-active-border);
            box-shadow: none;
            color: var(--topbar-search-text) !important;
        }
        .card-glass .form-label {
            color: var(--sidebar-link-color);
        }
        
        /* Modal Styles */
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--input-border-color);
            color: var(--text-color);
        }
        .modal-header {
             border-bottom: 1px solid var(--input-border-color);
        }
        .modal-footer {
             border-top: 1px solid var(--input-border-color);
        }
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        /* End Modal Styles */

        /* Improved Table Style */
        .table.table-dark {
            --bs-table-bg: transparent;
            --bs-table-border-color: var(--input-border-color);
            --bs-table-striped-bg: rgba(255, 255, 255, 0.02);
            --bs-table-hover-bg: rgba(255, 255, 255, 0.07);
        }
        .table thead th {
             color: var(--sidebar-link-color);
             text-transform: uppercase;
             font-size: 0.8rem;
             letter-spacing: 0.5px;
             border-bottom-width: 2px;
             border-bottom-color: var(--input-border-color);
        }
        .table .fw-bold {
            color: var(--text-color);
        }
        .table .text-muted {
             color: var(--sidebar-link-color) !important;
        }
    </style>
{% endblock %}


{% block admin_content %}
<div class="container-fluid">
    <h1 class="h2 mb-4 dash-title">Manage Categories</h1>

    {# Display Error/Success Messages from PHP redirects #}
    {% if error_message is defined and error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
    {% if success_message is defined and success_message %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ success_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    <div class="row g-4">
        {# Column 1: Add New Category Card #}
        <div class="col-lg-4">
            <div class="card card-glass h-100">
                <div class="card-header">
                    Add New Category
                </div>
                <div class="card-body">
                    {# Point action to the /admin/categories/add route #}
                    <form method="POST" action="{{ BASE_PATH }}/admin/categories/add"> 
                        <div class="mb-3">
                            <label for="category_name" class="form-label">Category Name</label>
                            <input type="text" class="form-control form-control-dark" id="category_name" name="category_name" placeholder="e.g., Electronics" required>
                        </div>
                        {# Add CSRF token here if using them #}
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i>Add Category
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {# Column 2: Existing Categories Table #}
        <div class="col-lg-8">
            <div class="card card-glass">
                <div class="card-header">
                    Existing Categories
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col">#ID</th>
                                    <th scope="col">Category Name</th>
                                    <th scope="col" class="text-center">Items</th>
                                    <th scope="col" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {# --- START: Dynamic Twig Loop --- #}
                                {% if categories is not empty %}
                                    {% for category in categories %}
                                    <tr>
                                        <th scope="row">{{ category.category_id }}</th>
                                        <td class="fw-bold">{{ category.category_name }}</td>
                                        <td class="text-center">{{ category.item_count }}</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-warning" title="Edit Category"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editModal"
                                                data-category-id="{{ category.category_id }}"
                                                data-category-name="{{ category.category_name | escape('html_attr') }}">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" title="Delete Category"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal"
                                                data-category-id="{{ category.category_id }}"
                                                data-category-name="{{ category.category_name | escape('html_attr') }}"
                                                data-item-count="{{ category.item_count }}">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">No categories found. Add one to get started!</td>
                                    </tr>
                                {% endif %}
                                {# --- END: Dynamic Twig Loop --- #}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Category</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      {# Form action is set dynamically by JavaScript #}
      <form id="editForm" action="" method="POST">
          <div class="modal-body">
                <input type="hidden" name="category_id" id="editCategoryId">
                <div class="mb-3">
                    <label for="editCategoryName" class="form-label">Category Name</label>
                    <input type="text" class="form-control form-control-dark" id="editCategoryName" name="category_name" required>
                </div>
                {# Add CSRF token here if using them #}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirm Deletion</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this category?</p>
        <p class="text-warning"><strong>Category: <span id="deleteCategoryName"></span></strong></p>
        <p class="text-danger small" id="deleteWarningText" style="display: none;">
            Warning: This category has <strong id="deleteItemCount">0</strong> items associated with it. Deleting this category will fail due to database constraints. You must re-assign its items first.
        </p>
         <p class="text-muted small" id="deleteSafeText" style="display: none;">
            This category has 0 items associated with it and is safe to delete.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        {# Form action is set dynamically by JavaScript #}
        <form id="deleteForm" action="" method="POST" style="display: inline;">
             <input type="hidden" name="category_id" id="deleteCategoryId">
             {# Add CSRF token here if using them #}
             <button type="submit" class="btn btn-danger" id="deleteConfirmButton">Delete Anyway</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }} {# Include base template JS if needed #}
<script>
    // JavaScript for Edit Modal
    const editModal = document.getElementById('editModal');
    if (editModal) {
      editModal.addEventListener('show.bs.modal', event => {
        const triggerButton = event.relatedTarget;
        const categoryId = triggerButton.getAttribute('data-category-id');
        const categoryName = triggerButton.getAttribute('data-category-name');
        
        const modalTitle = editModal.querySelector('.modal-title');
        const modalForm = editModal.querySelector('#editForm');
        const modalInputName = editModal.querySelector('#editCategoryName');
        const modalInputId = editModal.querySelector('#editCategoryId');

        modalTitle.textContent = `Edit Category: ${categoryName}`;
        modalInputName.value = categoryName;
        modalInputId.value = categoryId;
        // Set form action dynamically
        modalForm.action = `{{ BASE_PATH }}/admin/categories/edit`; 
      });
    }

    // JavaScript for Delete Confirmation Modal
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', event => {
            const triggerButton = event.relatedTarget;
            const categoryId = triggerButton.getAttribute('data-category-id');
            const categoryName = triggerButton.getAttribute('data-category-name');
            const itemCount = parseInt(triggerButton.getAttribute('data-item-count') || 0, 10);
            
            const modalCategoryName = deleteModal.querySelector('#deleteCategoryName');
            const deleteForm = deleteModal.querySelector('#deleteForm');
            const deleteCategoryIdInput = deleteModal.querySelector('#deleteCategoryId');
            const deleteWarningText = deleteModal.querySelector('#deleteWarningText');
            const deleteSafeText = deleteModal.querySelector('#deleteSafeText');
            const deleteItemCount = deleteModal.querySelector('#deleteItemCount');
            const deleteConfirmButton = deleteModal.querySelector('#deleteConfirmButton');

            modalCategoryName.textContent = categoryName;
            deleteCategoryIdInput.value = categoryId;
             // Set form action dynamically
            deleteForm.action = `{{ BASE_PATH }}/admin/categories/delete`;

            // Show warning if items are associated and disable button
            if (itemCount > 0) {
                deleteItemCount.textContent = itemCount;
                deleteWarningText.style.display = 'block';
                deleteSafeText.style.display = 'none';
                deleteConfirmButton.disabled = true; // Disable delete button
                deleteConfirmButton.title = "You must re-assign items from this category before deleting it.";
            } else {
                deleteWarningText.style.display = 'none';
                deleteSafeText.style.display = 'block'; // Show safe message
                deleteConfirmButton.disabled = false; // Enable delete button
                deleteConfirmButton.title = "";
            }
        });
    }
</script>
{% endblock %}

